#!/usr/bin/perl -w
use strict;

use FindBin;
my $TOP;
BEGIN { $TOP = "$FindBin::RealBin/.." }
use lib "$TOP/lib";

use Loom::DB::GNU;
use Loom::Quote::C;

main->new->run;

sub new
	{
	my $class = shift;
	my $s = bless({},$class);
	return $s;
	}

sub run
	{
	my $s = shift;

	$s->{quote} = Loom::Quote::C->new;

	$s->{file_old} = $ARGV[0];
	$s->{file_new} = $ARGV[1];

	if (!defined $s->{file_new})
		{
		print STDERR <<EOM;
Usage: dbcopy old new
EOM
		exit(2);
		}

	unless (-e $s->{file_old})
		{
		print STDERR "$s->{file_old} does not exist\n";
		exit(2);
		}

	if (-e $s->{file_new})
		{
		print STDERR "$s->{file_new} already exists\n";
		exit(2);
		}
	print "Copying $s->{file_old} to $s->{file_new}\n";

	$s->{db_old} = Loom::DB::GNU->new($s->{file_old});
	$s->{db_new} = Loom::DB::GNU->new($s->{file_new});

	my $count = 0;

	my $key = $s->{db_old}->first_key;
	while (defined $key)
		{
		$count++;

		if ($count % 1000 == 0)
			{
			my $q_key = $s->{quote}->quote($key);
			print "$count : $q_key\n";
			}

		my $val = $s->{db_old}->get($key);
		$s->{db_new}->put($key,$val);

		$key = $s->{db_old}->next_key($key);
		}

	print "count = $count\n";
	}
